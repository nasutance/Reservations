import{Q as G,j as f,k as J,f as a,o as r,b as s,a as K,w as T,F as g,g as A,l as y,m as q,p as O,t as d,s as M,e as p,n as W,q as v}from"./app-5sIL7s11.js";import{_ as X}from"./DataTable-DZ55UmEs.js";import{f as Y}from"./formatDate-D984MnE_.js";const Z=["onUpdate:modelValue"],ee={key:1},te={key:0},ie=["onUpdate:modelValue"],ne=["onUpdate:modelValue"],se={label:"üéüÔ∏è Tarifs publics"},oe=["value","disabled"],ae={label:"üîí Tarifs internes"},re=["value"],le=["onClick"],de={class:"mt-2 text-sm"},ue={key:1},ce=["innerHTML"],pe={class:"mt-1 text-sm"},ve={class:"flex flex-col gap-2 items-start mt-1"},me=["onClick"],_e=["onClick"],fe=["onClick"],ge=["onClick"],xe=["onClick"],Se={__name:"ResaSection",setup(ye){const m=G(),c=f(m.props.prices??[]),N=f(m.props.priceShow??[]);f(m.props.reservations??[]);const h=f([]),_=f(new Set);C(),J(()=>m.props.reservations,C);function C(){const n=m.props.reservations??[];h.value=n.map(t=>{var l,o,V,L,U;const e=t.representations.map(u=>({...u,pivot:{...u.pivot,id:u.pivot.id,original_price_id:u.pivot.price_id,original_quantity:u.pivot.quantity}})),i=e.reduce((u,E)=>{const S=c.value.find(w=>w.id===E.pivot.price_id);return u+E.pivot.quantity*((S==null?void 0:S.price)??0)},0);return{id:t.id,user:t.user?`${t.user.firstname} ${t.user.lastname}`:"-",showTitle:((o=(l=e[0])==null?void 0:l.show)==null?void 0:o.title)||"-",schedule:(V=e[0])!=null&&V.schedule?Y(e[0].schedule,!0):"-",location:((U=(L=e[0])==null?void 0:L.location)==null?void 0:U.designation)||"-",status:t.status,originalTotal:i,representations:e}})}function x(n){return _.value.has(n)}function $(n){x(n)?_.value.delete(n):_.value.add(n)}function R(n){return n.representations.reduce((t,e)=>{const i=c.value.find(l=>l.id===e.pivot.price_id);return t+e.pivot.quantity*((i==null?void 0:i.price)??0)},0)}function b(n){const t=R(n),e=n.originalTotal??t;return t-e}function k(n){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n)}function F(n){v.patch(`/reservation/${n.id}`,{status:n.status,representations:n.representations.map(t=>({price_id:t.pivot.price_id,quantity:t.pivot.quantity,original_price_id:t.pivot.original_price_id,original_quantity:t.pivot.original_quantity}))},{onSuccess:()=>{_.value.delete(n.id),v.reload({preserveScroll:!0})}})}function P(n){confirm("Supprimer cette r√©servation ?")&&v.delete(`/reservation/${n}`,{onSuccess:()=>{_.value.clear(),v.reload()}})}function D(n){const t=N.value.filter(e=>e.show_id===n.show_id).map(e=>e.price_id);return{public:c.value.filter(e=>t.includes(e.id)),internal:c.value.filter(e=>!t.includes(e.id))}}function j(n){const t=c.value.find(e=>e.id===n.pivot.price_id);return t?t.description:"Non d√©fini"}function B(n,t,e){return n.representations.some(i=>i!==t&&i.pivot.price_id===e)}function H(n){const t=n.representations.map(i=>i.pivot.price_id),e=c.value.find(i=>!t.includes(i.id));if(!e)return alert("Aucun tarif suppl√©mentaire disponible √† ajouter.");v.post(`/reservation/${n.id}/add-line`,{price_id:e.id},{preserveScroll:!0,onSuccess:()=>{var i;n.representations.push({id:Date.now(),show_id:((i=n.representations[0])==null?void 0:i.show_id)??null,pivot:{id:Date.now(),quantity:0,price_id:e.id,original_price_id:e.id,original_quantity:0}})}})}function Q(n,t,e){confirm("Supprimer cette ligne de r√©servation ?")&&v.delete(`/reservation/${n}/line/${t}/${e}`,{preserveScroll:!0,onSuccess:()=>{const i=h.value.find(l=>l.id===n);i&&(i.representations=i.representations.filter(l=>!(l.id===t&&l.pivot.price_id===e)))}})}const z=["#","Utilisateur","Spectacle","Date","Lieu","Statut","D√©tails","Actions"],I=["id","user","showTitle","schedule","location","status","detail","actions"];return(n,t)=>(r(),a("div",null,[t[8]||(t[8]=s("h3",{class:"text-xl font-semibold mb-4"},"Liste des r√©servations",-1)),K(X,{headers:z,fields:I,rows:h.value},{status:T(({row:e})=>[x(e.id)?q((r(),a("select",{key:0,"onUpdate:modelValue":i=>e.status=i,class:"border rounded px-2 py-1"},t[0]||(t[0]=[s("option",{value:"en attente"},"En attente",-1),s("option",{value:"pay√©e"},"Pay√©e",-1),s("option",{value:"annul√©e"},"Annul√©e",-1)]),8,Z)),[[M,e.status]]):(r(),a("span",ee,d(e.status),1))]),detail:T(({row:e})=>[x(e.id)?(r(),a("div",te,[t[5]||(t[5]=s("div",{class:"flex gap-2 mb-1 text-xs font-semibold text-gray-500"},[s("div",{class:"w-[60px]"},"Qt√©"),s("div",{class:"flex-1"},"Tarif"),s("div",{class:"w-6"})],-1)),(r(!0),a(g,null,y(e.representations,(i,l)=>(r(),a("div",{key:l,class:"flex items-center gap-2 mb-2"},[q(s("input",{type:"number","onUpdate:modelValue":o=>i.pivot.quantity=o,min:"0",class:"border rounded px-2 py-1 w-[60px] text-sm"},null,8,ie),[[O,i.pivot.quantity,void 0,{number:!0}]]),q(s("select",{"onUpdate:modelValue":o=>i.pivot.price_id=o,class:"border rounded px-2 py-1 flex-1 text-sm"},[s("optgroup",se,[(r(!0),a(g,null,y(D(i).public,o=>(r(),a("option",{key:"pub-"+o.id,value:o.id,disabled:B(e,i,o.id)},d(o.description)+" ‚Äî "+d(o.price)+" ‚Ç¨ ",9,oe))),128))]),s("optgroup",ae,[(r(!0),a(g,null,y(D(i).internal,o=>(r(),a("option",{key:"int-"+o.id,value:o.id},d(o.description)+" ‚Äî "+d(o.price)+" ‚Ç¨ ",9,re))),128))])],8,ne),[[M,i.pivot.price_id]]),s("button",{onClick:o=>Q(e.id,i.id,i.pivot.price_id),class:"text-red-600 text-sm",title:"Supprimer cette ligne"},"‚ùå",8,le)]))),128)),s("div",de,[t[1]||(t[1]=p(" üí∞ ")),t[2]||(t[2]=s("strong",null,"Total:",-1)),p(" "+d(k(R(e))),1)]),e.originalTotal!==void 0?(r(),a("div",{key:0,class:W(["text-sm",{"text-green-600":b(e)<0,"text-red-600":b(e)>0}])},[t[3]||(t[3]=p(" üîÅ ")),t[4]||(t[4]=s("strong",null,"Diff√©rence:",-1)),p(" "+d(k(b(e))),1)],2)):A("",!0)])):(r(),a("div",ue,[(r(!0),a(g,null,y(e.representations,(i,l)=>(r(),a("div",{key:l},[i.pivot.quantity>0?(r(),a("span",{key:0,innerHTML:i.pivot.quantity+" "+j(i)},null,8,ce)):A("",!0)]))),128)),s("div",pe,[t[6]||(t[6]=p(" üí∞ ")),t[7]||(t[7]=s("strong",null,"Total:",-1)),p(" "+d(k(e.originalTotal)),1)])]))]),actions:T(({row:e})=>[s("div",ve,[x(e.id)?(r(),a(g,{key:1},[s("button",{class:"text-green-600 text-sm hover:underline",onClick:i=>F(e)},"üíæ Enregistrer",8,_e),s("button",{class:"text-gray-600 text-sm hover:underline",onClick:i=>$(e.id)},"üîÑ Annuler",8,fe),s("button",{class:"text-red-600 text-sm hover:underline",onClick:i=>P(e.id)},"üóëÔ∏è Supprimer",8,ge),s("button",{class:"text-green-600 text-sm hover:underline",onClick:i=>H(e)},"‚ûï Ajouter un tarif",8,xe)],64)):(r(),a("button",{key:0,class:"text-blue-600 text-sm hover:underline",onClick:i=>$(e.id)},"‚úèÔ∏è Modifier",8,me))])]),_:1},8,["rows"])]))}};export{Se as default};
