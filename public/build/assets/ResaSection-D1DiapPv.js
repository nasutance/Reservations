import{j as h,Q as R,f as s,o,b as a,a as N,w as g,g as m,t as r,F as f,l as _,m as k,x as A,p as C,e as u,n as I,u as B,q as b}from"./app-RXuUjciw.js";import{_ as j}from"./DataTable-CeC2OQm2.js";import{u as H}from"./useFormattedReservations-B-ieWvSy.js";import"./formatDate-D984MnE_.js";const Q=["onUpdate:modelValue"],z={key:1},G={key:0},J=["onUpdate:modelValue"],K=["onUpdate:modelValue"],O={label:"üéüÔ∏è Tarifs publics"},W=["value","disabled"],X={label:"üîí Tarifs internes"},Y=["value"],Z={class:"mt-2 text-sm"},w={key:1},ee=["innerHTML"],te={class:"mt-1 text-sm"},ie={class:"flex gap-2 items-center"},ne=["onClick"],se=["onClick"],oe=["onClick"],ae=["onClick"],pe={__name:"ResaSection",setup(le){const{formattedReservations:q}=H();h("");const V=["#","Utilisateur","Spectacle","Date","Lieu","Statut","D√©tails","Actions"],U=["id","user","showTitle","schedule","location","status","detail","actions"],$=R().props.priceShow??[],c=R().props.prices??[],p=h(new Set);function d(n){return p.value.has(n)}function D(n){d(n)?p.value.delete(n):p.value.add(n)}function S(n){return n.representations.reduce((e,t)=>{const i=c.find(v=>v.id===t.pivot.price_id);return e+t.pivot.quantity*((i==null?void 0:i.price)??0)},0)}function y(n){const e=S(n);return e-(n.originalTotal??e)}function x(n){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n)}function P(n){b.patch(`/reservation/${n.id}`,{status:n.status,representations:n.representations.map(e=>({price_id:e.pivot.price_id,quantity:e.pivot.quantity,original_price_id:e.pivot.original_price_id,original_quantity:e.pivot.original_quantity}))},{onSuccess:()=>{p.value.delete(n.id),b.reload({preserveScroll:!0})}})}function E(n){confirm("Supprimer cette r√©servation ?")&&b.delete(`/reservation/${n}`,{onSuccess:()=>{p.value.clear(),window.location.reload()}})}function T(n){const e=n.show_id,t=$.filter(i=>i.show_id===e).map(i=>i.price_id);return{public:c.filter(i=>t.includes(i.id)),internal:c.filter(i=>!t.includes(i.id))}}function F(n){const e=c.find(t=>t.id===n.pivot.price_id);return e?e.description:"Non d√©fini"}function L(n,e,t){return n.representations.some(i=>i!==e&&i.pivot.price_id===t)}function M(n){const e=n.representations.map(i=>i.pivot.price_id),t=c.find(i=>!e.includes(i.id));if(!t){alert("Aucun tarif suppl√©mentaire disponible √† ajouter.");return}b.post(`/reservation/${n.id}/add-line`,{price_id:t.id},{preserveScroll:!0})}return(n,e)=>(o(),s("div",null,[e[9]||(e[9]=a("h3",{class:"text-xl font-semibold mb-4"},"Liste des r√©servations",-1)),N(j,{headers:V,fields:U,rows:B(q)},{status:g(({row:t})=>[d(t.id)?k((o(),s("select",{key:0,"onUpdate:modelValue":i=>t.status=i,class:"border rounded px-2 py-1"},e[0]||(e[0]=[a("option",{value:"en attente"},"en attente",-1),a("option",{value:"pay√©e"},"Pay√©e",-1),a("option",{value:"annul√©e"},"Annul√©e",-1)]),8,Q)),[[C,t.status]]):(o(),s("span",z,r(t.status),1))]),detail:g(({row:t})=>[d(t.id)?(o(),s("div",G,[(o(!0),s(f,null,_(t.representations,(i,v)=>(o(),s("div",{key:v,class:"mb-2"},[e[1]||(e[1]=a("label",{class:"block text-xs mb-1"},"Quantit√©",-1)),k(a("input",{type:"number","onUpdate:modelValue":l=>i.pivot.quantity=l,class:"border rounded px-2 py-1 w-10",min:"0"},null,8,J),[[A,i.pivot.quantity,void 0,{number:!0}]]),e[2]||(e[2]=a("label",{class:"block text-xs mt-2 mb-1"},"Tarif",-1)),k(a("select",{"onUpdate:modelValue":l=>i.pivot.price_id=l,class:"border rounded px-2 py-1 w-full"},[a("optgroup",O,[(o(!0),s(f,null,_(T(i).public,l=>(o(),s("option",{key:"pub-"+l.id,value:l.id,disabled:L(t,i,l.id)},r(l.description)+" ‚Äî "+r(l.price)+" ‚Ç¨ ",9,W))),128))]),a("optgroup",X,[(o(!0),s(f,null,_(T(i).internal,l=>(o(),s("option",{key:"int-"+l.id,value:l.id},r(l.description)+" ‚Äî "+r(l.price)+" ‚Ç¨ ",9,Y))),128))])],8,K),[[C,i.pivot.price_id]])]))),128)),a("div",Z,[e[3]||(e[3]=u(" üí∞ ")),e[4]||(e[4]=a("strong",null,"Total:",-1)),u(" "+r(x(S(t))),1)]),t.originalTotal!==void 0?(o(),s("div",{key:0,class:I(["text-sm",{"text-green-600":y(t)<0,"text-red-600":y(t)>0}])},[e[5]||(e[5]=u(" üîÅ ")),e[6]||(e[6]=a("strong",null,"Diff√©rence:",-1)),u(" "+r(x(y(t))),1)],2)):m("",!0)])):(o(),s("div",w,[(o(!0),s(f,null,_(t.representations,(i,v)=>(o(),s("div",{key:v},[i.pivot.quantity>0?(o(),s("span",{key:0,innerHTML:i.pivot.quantity+" "+F(i)},null,8,ee)):m("",!0)]))),128)),a("div",te,[e[7]||(e[7]=u(" üí∞ ")),e[8]||(e[8]=a("strong",null,"Total:",-1)),u(" "+r(x(t.originalTotal)),1)])]))]),actions:g(({row:t})=>[a("div",ie,[d(t.id)?(o(),s("button",{key:0,onClick:i=>M(t),class:"text-green-600 text-sm ml-2"}," ‚ûï ",8,ne)):m("",!0),a("button",{onClick:i=>D(t.id),class:"text-sm text-blue-600"},r(d(t.id)?"Annuler":"‚úèÔ∏è Modifier"),9,se),d(t.id)?(o(),s("button",{key:1,onClick:i=>P(t),class:"text-sm text-green-600"}," üíæ Enregistrer ",8,oe)):m("",!0),d(t.id)?(o(),s("button",{key:2,onClick:i=>E(t.id),class:"text-sm text-red-500 ml-2",title:"Supprimer la r√©servation"}," ‚ùå ",8,ae)):m("",!0)])]),_:1},8,["rows"])]))}};export{pe as default};
