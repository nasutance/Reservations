import{Q as P,j as y,k as V,f as o,o as n,b as i,a as Q,w as v,F as k,g as N,l as g,t as d,e as j,m as x,v as Y,p as w,q as U,s as b}from"./app-CBF-ljik.js";import{_ as z}from"./DataTable-CAT6zvj7.js";const G={key:0},J=["onUpdate:modelValue"],K=["onUpdate:modelValue"],W={key:1},X={key:0},Z=["onUpdate:modelValue"],ee=["value"],te={key:1,class:"flex items-center gap-2"},se=["src"],oe={key:2,class:"text-gray-400"},ne={key:0},le=["value","onUpdate:modelValue"],ae={key:1},ie={key:0},ce={class:"text-sm block mb-1"},de={class:"grid grid-cols-2 gap-1"},re=["value","checked","onChange"],pe={key:1},ue={key:0},me={key:1},_e={class:"flex flex-col gap-2 items-start mt-1"},he=["onClick"],ye=["onClick"],fe=["onClick"],ve=["onClick"],xe={__name:"ArtistSection",setup(ke){const r=P(),A=y(r.props.types??[]),E=y(r.props.shows??[]);y(r.props.artistTypes??[]);const L=y(r.props.troupes??[]),T=y([]),p=y(new Set);V(()=>r.props.artists,S),V(()=>r.props.artistTypes,S),S();function S(){const t=r.props.artists??[],l=r.props.artistTypes??[];T.value=t.map(e=>{var $;const s=l.filter(c=>c.artist_id===e.id),a=s.map(c=>c.type_id),m=Object.fromEntries(s.map(c=>{var h;return[c.type_id,((h=c.shows)==null?void 0:h.map(f=>f.id))??[]]})),_={};for(const c of s){const h=($=c.type)==null?void 0:$.type;for(const f of c.shows??[])_[f.title]||(_[f.title]=[]),_[f.title].push(h)}const H=Object.entries(_).map(([c,h])=>`${c} (${h.join(", ")})`).join(" / ");return{id:e.id,firstname:e.firstname,lastname:e.lastname,selectedTypeIds:a,selectedShowTypeMap:m,showsText:H,troupe_id:e.troupe_id??null,troupe:e.troupe?{name:e.troupe.name,logo_url:e.troupe.logo_url}:null}}),console.log("ARTISTES HYDRATÉS",T.value)}function u(t){return p.value.has(t)}function M(t){u(t)?p.value.delete(t):p.value.add(t)}function D(){const t={id:`new-${Date.now()}`,firstname:"",lastname:"",selectedTypeIds:[],selectedShowTypeMap:{},isNew:!0};T.value.unshift(t),p.value.add(t.id)}function C(t){var l;return((l=A.value.find(e=>e.id===t))==null?void 0:l.type)??`Type ${t}`}function O(t){return t.map(C)}async function R(t){const l=t.isNew?"post":"put",e=t.isNew?"/artist":`/artist/${t.id}`;for(const s of t.selectedTypeIds)Array.isArray(t.selectedShowTypeMap[s])||(t.selectedShowTypeMap[s]=[]);t.selectedShowTypeMap=Object.fromEntries(Object.entries(t.selectedShowTypeMap).map(([s,a])=>[Number(s),a])),await b[l](e,{firstname:t.firstname,lastname:t.lastname,troupe_id:t.troupe_id,types:t.selectedTypeIds,shows:t.selectedShowTypeMap},{onSuccess:()=>{p.value.delete(t.id),b.reload({preserveScroll:!0})}})}function B(t){confirm("Supprimer définitivement cet artiste ?")&&b.delete(`/artist/${t}`,{preserveScroll:!0,onSuccess:()=>{p.value.delete(t),b.reload({preserveScroll:!0})}})}function F(t,l,e,s){Array.isArray(t.selectedShowTypeMap[l])||(t.selectedShowTypeMap[l]=[]);const a=t.selectedShowTypeMap[l];s.target.checked&&!a.includes(e)?a.push(e):!s.target.checked&&a.includes(e)&&(t.selectedShowTypeMap[l]=a.filter(m=>m!==e))}const I=["Artiste","Types","Troupe","Spectacles","Actions"],q=["fullname","types","troupe","shows","actions"];return(t,l)=>(n(),o("div",null,[l[1]||(l[1]=i("h3",{class:"text-xl font-semibold mb-4"},"Liste des artistes",-1)),i("button",{onClick:D},"➕ Ajouter un artiste"),Q(z,{headers:I,fields:q,rows:T.value},{fullname:v(({row:e})=>[u(e.id)?(n(),o("div",G,[x(i("input",{"onUpdate:modelValue":s=>e.firstname=s,placeholder:"Prénom",class:"border px-2 py-1 rounded mr-1"},null,8,J),[[U,e.firstname]]),x(i("input",{"onUpdate:modelValue":s=>e.lastname=s,placeholder:"Nom",class:"border px-2 py-1 rounded"},null,8,K),[[U,e.lastname]])])):(n(),o("span",W,d(e.firstname)+" "+d(e.lastname),1))]),troupe:v(({row:e})=>[u(e.id)?(n(),o("div",X,[x(i("select",{"onUpdate:modelValue":s=>e.troupe_id=s,class:"border px-2 py-1 rounded w-full"},[l[0]||(l[0]=i("option",{value:null},"— Aucune troupe —",-1)),(n(!0),o(k,null,g(L.value,s=>(n(),o("option",{key:s.id,value:s.id},d(s.name),9,ee))),128))],8,Z),[[w,e.troupe_id]])])):e.troupe&&e.troupe.name?(n(),o("div",te,[e.troupe.logo_url?(n(),o("img",{key:0,src:`/images/${e.troupe.logo_url}`,class:"w-6 h-6 rounded-full object-cover",alt:"Logo"},null,8,se)):N("",!0),i("span",null,d(e.troupe.name),1)])):(n(),o("span",oe,"—"))]),types:v(({row:e})=>[u(e.id)?(n(),o("div",ne,[(n(!0),o(k,null,g(A.value,s=>(n(),o("label",{key:s.id,class:"block text-sm"},[x(i("input",{type:"checkbox",value:s.id,"onUpdate:modelValue":a=>e.selectedTypeIds=a,class:"mr-1"},null,8,le),[[Y,e.selectedTypeIds]]),j(" "+d(s.type),1)]))),128))])):(n(),o("span",ae,d(O(e.selectedTypeIds).join(", ")||"—"),1))]),shows:v(({row:e})=>[u(e.id)?(n(),o("div",ie,[(n(!0),o(k,null,g(e.selectedTypeIds,s=>(n(),o("div",{key:s,class:"mb-2"},[i("strong",ce,d(C(s)),1),i("div",de,[(n(!0),o(k,null,g(E.value,a=>{var m;return n(),o("label",{key:`type-${s}-show-${a.id}`,class:"text-sm"},[i("input",{type:"checkbox",value:a.id,checked:(m=e.selectedShowTypeMap[s])==null?void 0:m.includes(a.id),onChange:_=>F(e,s,a.id,_),class:"mr-1"},null,40,re),j(" "+d(a.title),1)])}),128))])]))),128))])):(n(),o("span",pe,[e.showsText?(n(),o("span",ue,d(e.showsText),1)):(n(),o("span",me,"—"))]))]),actions:v(({row:e})=>[i("div",_e,[u(e.id)?(n(),o(k,{key:1},[i("button",{class:"text-green-600 text-sm hover:underline",onClick:s=>R(e)}," 💾 Enregistrer ",8,ye),i("button",{class:"text-gray-600 text-sm hover:underline",onClick:s=>M(e.id)}," 🔄 Annuler ",8,fe),e.isNew?N("",!0):(n(),o("button",{key:0,class:"text-red-600 text-sm hover:underline",onClick:s=>B(e.id)}," 🗑️ Supprimer ",8,ve))],64)):(n(),o("button",{key:0,class:"text-blue-600 text-sm hover:underline",onClick:s=>M(e.id)}," ✏️ Modifier ",8,he))])]),_:1},8,["rows"])]))}};export{xe as default};
