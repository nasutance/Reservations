import{Q as J,j as _,k as K,f as a,o as r,b as s,a as O,w as S,F as x,g as A,l as y,m as T,p as W,t as d,s as M,e as p,n as X,q as v}from"./app-BMjlmMSH.js";import{_ as Y}from"./DataTable-B0UdSOJv.js";import{f as Z}from"./formatDate-D984MnE_.js";const w=["onUpdate:modelValue"],ee={key:1},te={key:0},ie=["onUpdate:modelValue"],ne=["onUpdate:modelValue"],se={label:"üéüÔ∏è Tarifs publics"},oe=["value","disabled"],ae={label:"üîí Tarifs internes"},re=["value"],le=["onClick"],de={class:"mt-2 text-sm"},ue={key:1},ce=["innerHTML"],pe={class:"mt-1 text-sm"},ve={class:"flex flex-col gap-2 items-start mt-1"},me=["onClick"],fe=["onClick"],_e=["onClick"],xe=["onClick"],ge=["onClick"],Se={__name:"ResaSection",setup(ye){const m=J(),c=_(m.props.prices??[]),N=_(m.props.priceShow??[]);_(m.props.reservations??[]);const C=_([]),f=_(new Set);$(),K(()=>m.props.reservations,$);function $(){const i=m.props.reservations??[];C.value=i.map(t=>{var l,o,D,L,U;const e=t.representations.map(u=>({...u,pivot:{...u.pivot,id:u.pivot.id,original_price_id:u.pivot.price_id,original_quantity:u.pivot.quantity}})),n=e.reduce((u,E)=>{const k=c.value.find(G=>G.id===E.pivot.price_id);return u+E.pivot.quantity*((k==null?void 0:k.price)??0)},0);return{id:t.id,user:t.user?`${t.user.firstname} ${t.user.lastname}`:"-",showTitle:((o=(l=e[0])==null?void 0:l.show)==null?void 0:o.title)||"-",schedule:(D=e[0])!=null&&D.schedule?Z(e[0].schedule,!0):"-",location:((U=(L=e[0])==null?void 0:L.location)==null?void 0:U.designation)||"-",status:t.status,originalTotal:n,representations:e}})}function g(i){return f.value.has(i)}function R(i){g(i)?f.value.delete(i):f.value.add(i)}function q(i){return i.representations.reduce((t,e)=>{const n=c.value.find(l=>l.id===e.pivot.price_id);return t+e.pivot.quantity*((n==null?void 0:n.price)??0)},0)}function b(i){const t=q(i),e=i.originalTotal??t;return t-e}function h(i){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(i)}function F(i){v.patch(`/reservation/${i.id}`,{status:i.status,representations:i.representations.map(t=>({price_id:t.pivot.price_id,quantity:t.pivot.quantity,original_price_id:t.pivot.original_price_id,original_quantity:t.pivot.original_quantity}))},{onSuccess:()=>{f.value.delete(i.id),v.reload({preserveScroll:!0})}})}function I(i){confirm("Supprimer cette r√©servation ?")&&v.delete(`/reservation/${i}`,{onSuccess:()=>{f.value.clear(),v.reload()}})}function V(i){const t=N.value.filter(e=>e.show_id===i.show_id).map(e=>e.price_id);return{public:c.value.filter(e=>t.includes(e.id)),internal:c.value.filter(e=>!t.includes(e.id))}}function P(i){const t=c.value.find(e=>e.id===i.pivot.price_id);return t?t.description:"Non d√©fini"}function j(i,t,e){return i.representations.some(n=>n!==t&&n.pivot.price_id===e)}function B(i){const t=i.representations.map(n=>n.pivot.price_id),e=c.value.find(n=>!t.includes(n.id));if(!e)return alert("Aucun tarif suppl√©mentaire disponible √† ajouter.");v.post(`/reservation/${i.id}/add-line`,{price_id:e.id},{preserveScroll:!0})}function H(i,t,e){confirm("Supprimer cette ligne de r√©servation ?")&&v.delete(`/reservation/${i}/line/${t}/${e}`,{preserveScroll:!0})}const Q=["#","Utilisateur","Spectacle","Date","Lieu","Statut","D√©tails","Actions"],z=["id","user","showTitle","schedule","location","status","detail","actions"];return(i,t)=>(r(),a("div",null,[t[8]||(t[8]=s("h3",{class:"text-xl font-semibold mb-4"},"Liste des r√©servations",-1)),O(Y,{headers:Q,fields:z,rows:C.value},{status:S(({row:e})=>[g(e.id)?T((r(),a("select",{key:0,"onUpdate:modelValue":n=>e.status=n,class:"border rounded px-2 py-1"},t[0]||(t[0]=[s("option",{value:"en attente"},"En attente",-1),s("option",{value:"pay√©e"},"Pay√©e",-1),s("option",{value:"annul√©e"},"Annul√©e",-1)]),8,w)),[[M,e.status]]):(r(),a("span",ee,d(e.status),1))]),detail:S(({row:e})=>[g(e.id)?(r(),a("div",te,[t[5]||(t[5]=s("div",{class:"flex gap-2 mb-1 text-xs font-semibold text-gray-500"},[s("div",{class:"w-[60px]"},"Qt√©"),s("div",{class:"flex-1"},"Tarif"),s("div",{class:"w-6"})],-1)),(r(!0),a(x,null,y(e.representations,(n,l)=>(r(),a("div",{key:l,class:"flex items-center gap-2 mb-2"},[T(s("input",{type:"number","onUpdate:modelValue":o=>n.pivot.quantity=o,min:"0",class:"border rounded px-2 py-1 w-[60px] text-sm"},null,8,ie),[[W,n.pivot.quantity,void 0,{number:!0}]]),T(s("select",{"onUpdate:modelValue":o=>n.pivot.price_id=o,class:"border rounded px-2 py-1 flex-1 text-sm"},[s("optgroup",se,[(r(!0),a(x,null,y(V(n).public,o=>(r(),a("option",{key:"pub-"+o.id,value:o.id,disabled:j(e,n,o.id)},d(o.description)+" ‚Äî "+d(o.price)+" ‚Ç¨ ",9,oe))),128))]),s("optgroup",ae,[(r(!0),a(x,null,y(V(n).internal,o=>(r(),a("option",{key:"int-"+o.id,value:o.id},d(o.description)+" ‚Äî "+d(o.price)+" ‚Ç¨ ",9,re))),128))])],8,ne),[[M,n.pivot.price_id]]),s("button",{onClick:o=>H(e.id,n.id,n.pivot.price_id),class:"text-red-600 text-sm",title:"Supprimer cette ligne"}," ‚ùå ",8,le)]))),128)),s("div",de,[t[1]||(t[1]=p(" üí∞ ")),t[2]||(t[2]=s("strong",null,"Total:",-1)),p(" "+d(h(q(e))),1)]),e.originalTotal!==void 0?(r(),a("div",{key:0,class:X(["text-sm",{"text-green-600":b(e)<0,"text-red-600":b(e)>0}])},[t[3]||(t[3]=p(" üîÅ ")),t[4]||(t[4]=s("strong",null,"Diff√©rence:",-1)),p(" "+d(h(b(e))),1)],2)):A("",!0)])):(r(),a("div",ue,[(r(!0),a(x,null,y(e.representations,(n,l)=>(r(),a("div",{key:l},[n.pivot.quantity>0?(r(),a("span",{key:0,innerHTML:n.pivot.quantity+" "+P(n)},null,8,ce)):A("",!0)]))),128)),s("div",pe,[t[6]||(t[6]=p(" üí∞ ")),t[7]||(t[7]=s("strong",null,"Total:",-1)),p(" "+d(h(e.originalTotal)),1)])]))]),actions:S(({row:e})=>[s("div",ve,[g(e.id)?(r(),a(x,{key:1},[s("button",{class:"text-green-600 text-sm hover:underline",onClick:n=>F(e)}," üíæ Enregistrer ",8,fe),s("button",{class:"text-gray-600 text-sm hover:underline",onClick:n=>R(e.id)}," üîÑ Annuler ",8,_e),s("button",{class:"text-red-600 text-sm hover:underline",onClick:n=>I(e.id)}," üóëÔ∏è Supprimer ",8,xe),s("button",{class:"text-green-600 text-sm hover:underline",onClick:n=>B(e)}," ‚ûï Ajouter un tarif ",8,ge)],64)):(r(),a("button",{key:0,class:"text-blue-600 text-sm hover:underline",onClick:n=>R(e.id)}," ‚úèÔ∏è Modifier ",8,me))])]),_:1},8,["rows"])]))}};export{Se as default};
